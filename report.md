# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Weak Randomness](#h-1-weak-randomness)
  - [H-2: Reentrancy: State change after external call](#h-2-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Unsafe ERC20 Operation](#l-2-unsafe-erc20-operation)
  - [L-3: Address State Variable Set Without Checks](#l-3-address-state-variable-set-without-checks)
  - [L-4: Literal Instead of Constant](#l-4-literal-instead-of-constant)
  - [L-5: Unsafe `ERC721::_mint()`](#l-5-unsafe-erc721mint)
  - [L-6: Modifier Invoked Only Once](#l-6-modifier-invoked-only-once)
  - [L-7: Empty Block](#l-7-empty-block)
  - [L-8: Large Numeric Literal](#l-8-large-numeric-literal)
  - [L-9: Dead Code](#l-9-dead-code)
  - [L-10: Costly operations inside loop](#l-10-costly-operations-inside-loop)
  - [L-11: Unused Import](#l-11-unused-import)
  - [L-12: State Change Without Event](#l-12-state-change-without-event)
  - [L-13: Unchecked Return](#l-13-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 21 |
| Total nSLOC | 1777 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/RoyaltyModule.sol | 6 |
| src/core/LendingProtocol.sol | 298 |
| src/core/RangeValidator.sol | 55 |
| src/core/Stash.sol | 108 |
| src/core/lending/AdminManager.sol | 83 |
| src/core/lending/LoanManager.sol | 372 |
| src/core/lending/OfferManager.sol | 87 |
| src/core/lending/RefinanceManager.sol | 164 |
| src/core/lending/RequestManager.sol | 64 |
| src/core/manager/CollectionManager.sol | 47 |
| src/core/manager/CurrencyManager.sol | 52 |
| src/core/manager/RoyaltyManager.sol | 52 |
| src/interfaces/ICollectionManager.sol | 9 |
| src/interfaces/ICurrencyManager.sol | 9 |
| src/interfaces/ILendingProtocol.sol | 209 |
| src/interfaces/ILiquidation.sol | 65 |
| src/interfaces/IPurchaseBundler.sol | 46 |
| src/interfaces/IRangeValidator.sol | 12 |
| src/interfaces/IRoyaltyManager.sol | 7 |
| src/interfaces/IStash.sol | 25 |
| src/interfaces/IStoryProtocolAccess.sol | 7 |
| **Total** | **1777** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 2 |
| Low | 13 |


# High Issues

## H-1: Weak Randomness

The use of keccak256 hash functions on predictable values like block.timestamp, block.number, or similar data, including modulo operations on these values, should be avoided for generating randomness, as they are easily predictable and manipulable. The `PREVRANDAO` opcode also should not be used as a source of randomness. Instead, utilize Chainlink VRF for cryptographically secure and provably random values to ensure protocol integrity.

<details><summary>2 Found Instances</summary>


- Found in src/core/lending/OfferManager.sol [Line: 75](src/core/lending/OfferManager.sol#L75)

	```solidity
	        offerId = keccak256(abi.encodePacked("offer", offerCounter, msg.sender, block.timestamp));
	```

- Found in src/core/lending/RequestManager.sol [Line: 57](src/core/lending/RequestManager.sol#L57)

	```solidity
	        requestId = keccak256(
	```

</details>



## H-2: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>27 Found Instances</summary>


- Found in src/core/Stash.sol [Line: 77](src/core/Stash.sol#L77)

	State is changed at: `stashTokenCounter++`, `stashedTokenDetails[stashTokenId] =
            StashedTokenInfo({originalContract: originalContract, originalTokenId: originalTokenId, isStashed: true})`, `originalToStashId[originalKey] = stashTokenId`
	```solidity
	        address retrievedIpId = iipAssetRegistry.ipId(block.chainid, originalContract, originalTokenId);
	```

- Found in src/core/Stash.sol [Line: 79](src/core/Stash.sol#L79)

	State is changed at: `stashTokenCounter++`, `stashedTokenDetails[stashTokenId] =
            StashedTokenInfo({originalContract: originalContract, originalTokenId: originalTokenId, isStashed: true})`, `originalToStashId[originalKey] = stashTokenId`
	```solidity
	            require(
	```

- Found in src/core/lending/LoanManager.sol [Line: 143](src/core/lending/LoanManager.sol#L143)

	State is changed at: `loanCounter++`, `loans[loanId] = ILendingProtocol.Loan({ // Corrected
            loanId: loanId,
            offerId: offerId,
            borrower: msg.sender,
            lender: offer.lender,
            nftContract: effectiveCollateralContract,
            nftTokenId: effectiveCollateralTokenId,
            isVault: false, // Always false, vaults not supported
            currency: offer.currency,
            principalAmount: offer.principalAmount,
            interestRateAPR: offer.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE, // Corrected
            storyIpId: loanStoryIpId,
            isStoryAsset: loanIsStoryAsset
        })`
	```solidity
	            require(
	```

- Found in src/core/lending/LoanManager.sol [Line: 150](src/core/lending/LoanManager.sol#L150)

	State is changed at: `loanCounter++`, `loans[loanId] = ILendingProtocol.Loan({ // Corrected
            loanId: loanId,
            offerId: offerId,
            borrower: msg.sender,
            lender: offer.lender,
            nftContract: effectiveCollateralContract,
            nftTokenId: effectiveCollateralTokenId,
            isVault: false, // Always false, vaults not supported
            currency: offer.currency,
            principalAmount: offer.principalAmount,
            interestRateAPR: offer.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE, // Corrected
            storyIpId: loanStoryIpId,
            isStoryAsset: loanIsStoryAsset
        })`
	```solidity
	        address retrievedIpId =
	```

- Found in src/core/lending/LoanManager.sol [Line: 152](src/core/lending/LoanManager.sol#L152)

	State is changed at: `loanCounter++`, `loans[loanId] = ILendingProtocol.Loan({ // Corrected
            loanId: loanId,
            offerId: offerId,
            borrower: msg.sender,
            lender: offer.lender,
            nftContract: effectiveCollateralContract,
            nftTokenId: effectiveCollateralTokenId,
            isVault: false, // Always false, vaults not supported
            currency: offer.currency,
            principalAmount: offer.principalAmount,
            interestRateAPR: offer.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE, // Corrected
            storyIpId: loanStoryIpId,
            isStoryAsset: loanIsStoryAsset
        })`
	```solidity
	        if (retrievedIpId != address(0) && ipAssetRegistry.isRegistered(retrievedIpId)) {
	```

- Found in src/core/lending/LoanManager.sol [Line: 161](src/core/lending/LoanManager.sol#L161)

	State is changed at: `loanCounter++`, `loans[loanId] = ILendingProtocol.Loan({ // Corrected
            loanId: loanId,
            offerId: offerId,
            borrower: msg.sender,
            lender: offer.lender,
            nftContract: effectiveCollateralContract,
            nftTokenId: effectiveCollateralTokenId,
            isVault: false, // Always false, vaults not supported
            currency: offer.currency,
            principalAmount: offer.principalAmount,
            interestRateAPR: offer.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE, // Corrected
            storyIpId: loanStoryIpId,
            isStoryAsset: loanIsStoryAsset
        })`
	```solidity
	        require(IERC721(effectiveCollateralContract).ownerOf(effectiveCollateralTokenId) == msg.sender, "Not NFT owner");
	```

- Found in src/core/lending/LoanManager.sol [Line: 163](src/core/lending/LoanManager.sol#L163)

	State is changed at: `loanCounter++`, `loans[loanId] = ILendingProtocol.Loan({ // Corrected
            loanId: loanId,
            offerId: offerId,
            borrower: msg.sender,
            lender: offer.lender,
            nftContract: effectiveCollateralContract,
            nftTokenId: effectiveCollateralTokenId,
            isVault: false, // Always false, vaults not supported
            currency: offer.currency,
            principalAmount: offer.principalAmount,
            interestRateAPR: offer.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE, // Corrected
            storyIpId: loanStoryIpId,
            isStoryAsset: loanIsStoryAsset
        })`
	```solidity
	        IERC721(effectiveCollateralContract).safeTransferFrom(msg.sender, address(this), effectiveCollateralTokenId);
	```

- Found in src/core/lending/LoanManager.sol [Line: 227](src/core/lending/LoanManager.sol#L227)

	State is changed at: `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`
	```solidity
	        uint256 interest = this.calculateInterest(loanId); // Added this.
	```

- Found in src/core/lending/LoanManager.sol [Line: 231](src/core/lending/LoanManager.sol#L231)

	State is changed at: `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`
	```solidity
	        IERC721(loan.nftContract).safeTransferFrom(address(this), loan.borrower, loan.nftTokenId);
	```

- Found in src/core/lending/LoanManager.sol [Line: 246](src/core/lending/LoanManager.sol#L246)

	State is changed at: `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.principalAmount = originalPrincipal - amountToWithdrawFromRoyalty`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`
	```solidity
	        address ipIdToUse =
	```

- Found in src/core/lending/LoanManager.sol [Line: 253](src/core/lending/LoanManager.sol#L253)

	State is changed at: `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.principalAmount = originalPrincipal - amountToWithdrawFromRoyalty`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`
	```solidity
	        royaltyManager.claimRoyalty(ipIdToUse, loan.currency);
	```

- Found in src/core/lending/LoanManager.sol [Line: 254](src/core/lending/LoanManager.sol#L254)

	State is changed at: `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.principalAmount = originalPrincipal - amountToWithdrawFromRoyalty`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`
	```solidity
	        uint256 royaltyBalance = royaltyManager.getRoyaltyBalance(ipIdToUse, loan.currency);
	```

- Found in src/core/lending/LoanManager.sol [Line: 257](src/core/lending/LoanManager.sol#L257)

	State is changed at: `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.principalAmount = originalPrincipal - amountToWithdrawFromRoyalty`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`
	```solidity
	        uint256 interest = this.calculateInterest(loanId); // Added this.
	```

- Found in src/core/lending/LoanManager.sol [Line: 263](src/core/lending/LoanManager.sol#L263)

	State is changed at: `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.principalAmount = originalPrincipal - amountToWithdrawFromRoyalty`, `loan.accruedInterest = interest`, `loan.status = ILendingProtocol.LoanStatus.REPAID`
	```solidity
	            royaltyManager.withdrawRoyalty(ipIdToUse, loan.currency, loan.lender, amountToWithdrawFromRoyalty);
	```

- Found in src/core/lending/LoanManager.sol [Line: 339](src/core/lending/LoanManager.sol#L339)

	State is changed at: `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`
	```solidity
	        uint256 interest = this.calculateInterest(loanId); // Added this.
	```

- Found in src/core/lending/LoanManager.sol [Line: 347](src/core/lending/LoanManager.sol#L347)

	State is changed at: `loan.status = ILendingProtocol.LoanStatus.REPAID`, `loan.accruedInterest = interest`
	```solidity
	        IERC721(loan.nftContract).safeTransferFrom(address(this), msg.sender, loan.nftTokenId);
	```

- Found in src/core/lending/LoanManager.sol [Line: 393](src/core/lending/LoanManager.sol#L393)

	State is changed at: `loanCounter = _incrementLoanCounter()`, `loans[loanId] = ILendingProtocol.Loan({
            loanId: loanId,
            offerId: requestId, // Store requestId here; could rename field or use a union if OfferId vs RequestId matters elsewhere
            borrower: request.borrower,
            lender: msg.sender, // The one accepting the request is the lender
            nftContract: request.nftContract,
            nftTokenId: request.nftTokenId,
            isVault: false, // Assuming direct NFT loans, not vaults
            currency: request.currency,
            principalAmount: request.principalAmount,
            interestRateAPR: request.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE,
            storyIpId: address(0), // Assuming not a Story Protocol asset by default for requests
            isStoryAsset: false // ^
        })`
	```solidity
	        require(currencyManager.isCurrencySupported(request.currency), "LM: Currency not supported");
	```

- Found in src/core/lending/LoanManager.sol [Line: 396](src/core/lending/LoanManager.sol#L396)

	State is changed at: `loanCounter = _incrementLoanCounter()`, `loans[loanId] = ILendingProtocol.Loan({
            loanId: loanId,
            offerId: requestId, // Store requestId here; could rename field or use a union if OfferId vs RequestId matters elsewhere
            borrower: request.borrower,
            lender: msg.sender, // The one accepting the request is the lender
            nftContract: request.nftContract,
            nftTokenId: request.nftTokenId,
            isVault: false, // Assuming direct NFT loans, not vaults
            currency: request.currency,
            principalAmount: request.principalAmount,
            interestRateAPR: request.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE,
            storyIpId: address(0), // Assuming not a Story Protocol asset by default for requests
            isStoryAsset: false // ^
        })`
	```solidity
	        require(
	```

- Found in src/core/lending/LoanManager.sol [Line: 402](src/core/lending/LoanManager.sol#L402)

	State is changed at: `loanCounter = _incrementLoanCounter()`, `loans[loanId] = ILendingProtocol.Loan({
            loanId: loanId,
            offerId: requestId, // Store requestId here; could rename field or use a union if OfferId vs RequestId matters elsewhere
            borrower: request.borrower,
            lender: msg.sender, // The one accepting the request is the lender
            nftContract: request.nftContract,
            nftTokenId: request.nftTokenId,
            isVault: false, // Assuming direct NFT loans, not vaults
            currency: request.currency,
            principalAmount: request.principalAmount,
            interestRateAPR: request.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE,
            storyIpId: address(0), // Assuming not a Story Protocol asset by default for requests
            isStoryAsset: false // ^
        })`
	```solidity
	        require(
	```

- Found in src/core/lending/LoanManager.sol [Line: 409](src/core/lending/LoanManager.sol#L409)

	State is changed at: `loanCounter = _incrementLoanCounter()`, `loans[loanId] = ILendingProtocol.Loan({
            loanId: loanId,
            offerId: requestId, // Store requestId here; could rename field or use a union if OfferId vs RequestId matters elsewhere
            borrower: request.borrower,
            lender: msg.sender, // The one accepting the request is the lender
            nftContract: request.nftContract,
            nftTokenId: request.nftTokenId,
            isVault: false, // Assuming direct NFT loans, not vaults
            currency: request.currency,
            principalAmount: request.principalAmount,
            interestRateAPR: request.interestRateAPR,
            originationFeePaid: originationFee,
            startTime: startTime,
            dueTime: dueTime,
            accruedInterest: 0,
            status: ILendingProtocol.LoanStatus.ACTIVE,
            storyIpId: address(0), // Assuming not a Story Protocol asset by default for requests
            isStoryAsset: false // ^
        })`
	```solidity
	        IERC721(request.nftContract).safeTransferFrom(request.borrower, address(this), request.nftTokenId);
	```

- Found in src/core/lending/OfferManager.sol [Line: 56](src/core/lending/OfferManager.sol#L56)

	State is changed at: `offerCounter++`, `loanOffers[offerId] = ILendingProtocol.LoanOffer({
            offerId: offerId,
            lender: msg.sender,
            offerType: params.offerType,
            nftContract: params.nftContract,
            nftTokenId: params.nftTokenId,
            currency: params.currency,
            principalAmount: params.principalAmount,
            interestRateAPR: params.interestRateAPR,
            durationSeconds: params.durationSeconds,
            expirationTimestamp: params.expirationTimestamp,
            originationFeeRate: params.originationFeeRate,
            maxSeniorRepayment: 0, // Should this be part of params? For now, default.
            totalCapacity: params.totalCapacity,
            maxPrincipalPerLoan: params.maxPrincipalPerLoan,
            minNumberOfLoans: params.minNumberOfLoans,
            isActive: true
        })`
	```solidity
	        require(currencyManager.isCurrencySupported(params.currency), "Currency not supported");
	```

- Found in src/core/lending/OfferManager.sol [Line: 63](src/core/lending/OfferManager.sol#L63)

	State is changed at: `offerCounter++`, `loanOffers[offerId] = ILendingProtocol.LoanOffer({
            offerId: offerId,
            lender: msg.sender,
            offerType: params.offerType,
            nftContract: params.nftContract,
            nftTokenId: params.nftTokenId,
            currency: params.currency,
            principalAmount: params.principalAmount,
            interestRateAPR: params.interestRateAPR,
            durationSeconds: params.durationSeconds,
            expirationTimestamp: params.expirationTimestamp,
            originationFeeRate: params.originationFeeRate,
            maxSeniorRepayment: 0, // Should this be part of params? For now, default.
            totalCapacity: params.totalCapacity,
            maxPrincipalPerLoan: params.maxPrincipalPerLoan,
            minNumberOfLoans: params.minNumberOfLoans,
            isActive: true
        })`
	```solidity
	            require(collectionManager.isCollectionWhitelisted(params.nftContract), "Collection not whitelisted");
	```

- Found in src/core/lending/OfferManager.sol [Line: 66](src/core/lending/OfferManager.sol#L66)

	State is changed at: `offerCounter++`, `loanOffers[offerId] = ILendingProtocol.LoanOffer({
            offerId: offerId,
            lender: msg.sender,
            offerType: params.offerType,
            nftContract: params.nftContract,
            nftTokenId: params.nftTokenId,
            currency: params.currency,
            principalAmount: params.principalAmount,
            interestRateAPR: params.interestRateAPR,
            durationSeconds: params.durationSeconds,
            expirationTimestamp: params.expirationTimestamp,
            originationFeeRate: params.originationFeeRate,
            maxSeniorRepayment: 0, // Should this be part of params? For now, default.
            totalCapacity: params.totalCapacity,
            maxPrincipalPerLoan: params.maxPrincipalPerLoan,
            minNumberOfLoans: params.minNumberOfLoans,
            isActive: true
        })`
	```solidity
	            require(collectionManager.isCollectionWhitelisted(params.nftContract), "Collection not whitelisted");
	```

- Found in src/core/lending/RequestManager.sol [Line: 45](src/core/lending/RequestManager.sol#L45)

	State is changed at: `requestCounter++`, `loanRequests[requestId] = ILendingProtocol.LoanRequest({
            requestId: requestId,
            borrower: msg.sender,
            nftContract: params.nftContract,
            nftTokenId: params.nftTokenId,
            currency: params.currency,
            principalAmount: params.principalAmount,
            interestRateAPR: params.interestRateAPR,
            durationSeconds: params.durationSeconds,
            expirationTimestamp: params.expirationTimestamp,
            isActive: true
        })`
	```solidity
	        require(currencyManager.isCurrencySupported(params.currency), "RM: Currency not supported");
	```

- Found in src/core/lending/RequestManager.sol [Line: 46](src/core/lending/RequestManager.sol#L46)

	State is changed at: `requestCounter++`, `loanRequests[requestId] = ILendingProtocol.LoanRequest({
            requestId: requestId,
            borrower: msg.sender,
            nftContract: params.nftContract,
            nftTokenId: params.nftTokenId,
            currency: params.currency,
            principalAmount: params.principalAmount,
            interestRateAPR: params.interestRateAPR,
            durationSeconds: params.durationSeconds,
            expirationTimestamp: params.expirationTimestamp,
            isActive: true
        })`
	```solidity
	        require(collectionManager.isCollectionWhitelisted(params.nftContract), "RM: Collection not whitelisted");
	```

- Found in src/core/lending/RequestManager.sol [Line: 47](src/core/lending/RequestManager.sol#L47)

	State is changed at: `requestCounter++`, `loanRequests[requestId] = ILendingProtocol.LoanRequest({
            requestId: requestId,
            borrower: msg.sender,
            nftContract: params.nftContract,
            nftTokenId: params.nftTokenId,
            currency: params.currency,
            principalAmount: params.principalAmount,
            interestRateAPR: params.interestRateAPR,
            durationSeconds: params.durationSeconds,
            expirationTimestamp: params.expirationTimestamp,
            isActive: true
        })`
	```solidity
	        require(IERC721(params.nftContract).ownerOf(params.nftTokenId) == msg.sender, "RM: Not NFT owner");
	```

- Found in src/core/manager/RoyaltyManager.sol [Line: 60](src/core/manager/RoyaltyManager.sol#L60)

	State is changed at: `ipaRoyaltyClaims[ipId][currencyToken] += collectedAmount`
	```solidity
	        uint256 collectedAmount = RoyaltyModule(address(ROYALTY_MODULE)).collectRoyaltyTokens(ipId, currencyToken);
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>8 Found Instances</summary>


- Found in src/core/RangeValidator.sol [Line: 13](src/core/RangeValidator.sol#L13)

	```solidity
	contract RangeValidator is IRangeValidator, Ownable {
	```

- Found in src/core/RangeValidator.sol [Line: 105](src/core/RangeValidator.sol#L105)

	```solidity
	        onlyOwner
	```

- Found in src/core/RangeValidator.sol [Line: 124](src/core/RangeValidator.sol#L124)

	```solidity
	    ) external override onlyOwner {
	```

- Found in src/core/Stash.sol [Line: 19](src/core/Stash.sol#L19)

	```solidity
	contract Stash is IStash, ERC721, Ownable, IERC721Receiver {
	```

- Found in src/core/manager/CollectionManager.sol [Line: 14](src/core/manager/CollectionManager.sol#L14)

	```solidity
	contract CollectionManager is ICollectionManager, Ownable, ReentrancyGuard {
	```

- Found in src/core/manager/CollectionManager.sol [Line: 29](src/core/manager/CollectionManager.sol#L29)

	```solidity
	    function addWhitelistedCollection(address collectionAddress) external override onlyOwner {
	```

- Found in src/core/manager/CollectionManager.sol [Line: 55](src/core/manager/CollectionManager.sol#L55)

	```solidity
	    function removeWhitelistedCollection(address collectionAddress) external override onlyOwner {
	```

- Found in src/core/manager/RoyaltyManager.sol [Line: 20](src/core/manager/RoyaltyManager.sol#L20)

	```solidity
	contract RoyaltyManager is IRoyaltyManager, Ownable {
	```

</details>



## L-2: Unsafe ERC20 Operation

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>2 Found Instances</summary>


- Found in src/core/lending/LoanManager.sol [Line: 321](src/core/lending/LoanManager.sol#L321)

	```solidity
	        IERC721(loan.nftContract).approve(address(purchaseBundler), loan.nftTokenId);
	```

- Found in src/core/manager/RoyaltyManager.sol [Line: 95](src/core/manager/RoyaltyManager.sol#L95)

	```solidity
	        IERC20(currencyToken).transfer(recipient, amount);
	```

</details>



## L-3: Address State Variable Set Without Checks

Check for `address(0)` when assigning values to address state variables.

<details><summary>6 Found Instances</summary>


- Found in src/core/LendingProtocol.sol [Line: 173](src/core/LendingProtocol.sol#L173)

	```solidity
	        currencyManager = newManager;
	```

- Found in src/core/LendingProtocol.sol [Line: 177](src/core/LendingProtocol.sol#L177)

	```solidity
	        collectionManager = newManager;
	```

- Found in src/core/LendingProtocol.sol [Line: 181](src/core/LendingProtocol.sol#L181)

	```solidity
	        liquidationContract = newContract;
	```

- Found in src/core/LendingProtocol.sol [Line: 185](src/core/LendingProtocol.sol#L185)

	```solidity
	        purchaseBundler = newBundler;
	```

- Found in src/core/LendingProtocol.sol [Line: 189](src/core/LendingProtocol.sol#L189)

	```solidity
	        royaltyManager = newManager;
	```

- Found in src/core/LendingProtocol.sol [Line: 193](src/core/LendingProtocol.sol#L193)

	```solidity
	        ipAssetRegistry = newRegistry;
	```

</details>



## L-4: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>2 Found Instances</summary>


- Found in src/core/lending/LoanManager.sol [Line: 169](src/core/lending/LoanManager.sol#L169)

	```solidity
	        uint256 originationFee = (offer.principalAmount * offer.originationFeeRate) / 10000;
	```

- Found in src/core/lending/LoanManager.sol [Line: 218](src/core/lending/LoanManager.sol#L218)

	```solidity
	        return (loan.principalAmount * loan.interestRateAPR * timeElapsed) / (365 days * 10000); // Renamed
	```

</details>



## L-5: Unsafe `ERC721::_mint()`

Using `ERC721::_mint()` can mint ERC721 tokens to addresses which don't support ERC721 tokens. Use `_safeMint()` instead of `_mint()` for ERC721 tokens.

<details><summary>1 Found Instances</summary>


- Found in src/core/Stash.sol [Line: 99](src/core/Stash.sol#L99)

	```solidity
	        _mint(msg.sender, stashTokenId);
	```

</details>



## L-6: Modifier Invoked Only Once

Consider removing the modifier or inlining the logic into the calling function.

<details><summary>1 Found Instances</summary>


- Found in src/core/lending/LoanManager.sol [Line: 33](src/core/lending/LoanManager.sol#L33)

	```solidity
	    modifier onlyLender(bytes32 loanId) {
	```

</details>



## L-7: Empty Block

Consider removing empty blocks.

<details><summary>12 Found Instances</summary>


- Found in src/core/RangeValidator.sol [Line: 41](src/core/RangeValidator.sol#L41)

	```solidity
	    function isTokenIdValidForCollectionOffer(address collectionAddress, uint256 tokenId)
	```

- Found in src/core/lending/AdminManager.sol [Line: 43](src/core/lending/AdminManager.sol#L43)

	```solidity
	    function _setCurrencyManager(ICurrencyManager) internal virtual {
	```

- Found in src/core/lending/AdminManager.sol [Line: 47](src/core/lending/AdminManager.sol#L47)

	```solidity
	    function _setCollectionManager(ICollectionManager) internal virtual {
	```

- Found in src/core/lending/AdminManager.sol [Line: 51](src/core/lending/AdminManager.sol#L51)

	```solidity
	    function _setLiquidationContract(ILiquidation) internal virtual {
	```

- Found in src/core/lending/AdminManager.sol [Line: 55](src/core/lending/AdminManager.sol#L55)

	```solidity
	    function _setPurchaseBundler(IPurchaseBundler) internal virtual {
	```

- Found in src/core/lending/AdminManager.sol [Line: 59](src/core/lending/AdminManager.sol#L59)

	```solidity
	    function _setRoyaltyManager(IRoyaltyManager) internal virtual {
	```

- Found in src/core/lending/AdminManager.sol [Line: 63](src/core/lending/AdminManager.sol#L63)

	```solidity
	    function _setIpAssetRegistry(IIPAssetRegistry) internal virtual {
	```

- Found in src/core/lending/LoanManager.sol [Line: 91](src/core/lending/LoanManager.sol#L91)

	```solidity
	    function _setLoanOfferInactive(bytes32) internal virtual {
	```

- Found in src/core/lending/LoanManager.sol [Line: 112](src/core/lending/LoanManager.sol#L112)

	```solidity
	    function _setLoanRequestInactive(bytes32) internal virtual {
	```

- Found in src/core/lending/RefinanceManager.sol [Line: 78](src/core/lending/RefinanceManager.sol#L78)

	```solidity
	    function _setLoanStatus(bytes32 loanId, ILendingProtocol.LoanStatus status) internal virtual { /* revert("RM: LoanManager not set"); */ }
	```

- Found in src/core/lending/RefinanceManager.sol [Line: 85](src/core/lending/RefinanceManager.sol#L85)

	```solidity
	    function _addLoan(bytes32 loanId, ILendingProtocol.Loan memory loanData) internal virtual { /* revert("RM: LoanManager not set"); */ } // Changed to memory
	```

- Found in src/core/lending/RefinanceManager.sol [Line: 92](src/core/lending/RefinanceManager.sol#L92)

	```solidity
	    function _updateLoanAfterRenegotiation(bytes32 loanId, uint256 newPrincipal, uint256 newAPR, uint64 newDueTime)
	```

</details>



## L-8: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>2 Found Instances</summary>


- Found in src/core/lending/LoanManager.sol [Line: 169](src/core/lending/LoanManager.sol#L169)

	```solidity
	        uint256 originationFee = (offer.principalAmount * offer.originationFeeRate) / 10000;
	```

- Found in src/core/lending/LoanManager.sol [Line: 218](src/core/lending/LoanManager.sol#L218)

	```solidity
	        return (loan.principalAmount * loan.interestRateAPR * timeElapsed) / (365 days * 10000); // Renamed
	```

</details>



## L-9: Dead Code

Functions that are not used. Consider removing them.

<details><summary>6 Found Instances</summary>


- Found in src/core/lending/LoanManager.sol [Line: 469](src/core/lending/LoanManager.sol#L469)

	```solidity
	    function _setLoanStatus(bytes32 loanId, ILendingProtocol.LoanStatus status) internal virtual {
	```

- Found in src/core/lending/LoanManager.sol [Line: 480](src/core/lending/LoanManager.sol#L480)

	```solidity
	    function _addLoan(bytes32 loanId, ILendingProtocol.Loan memory newLoanData) internal virtual {
	```

- Found in src/core/lending/LoanManager.sol [Line: 486](src/core/lending/LoanManager.sol#L486)

	```solidity
	    function _updateLoanAfterRenegotiation(bytes32 loanId, uint256 newPrincipal, uint256 newAPR, uint64 newDueTime)
	```

- Found in src/core/lending/OfferManager.sol [Line: 143](src/core/lending/OfferManager.sol#L143)

	```solidity
	    function _setLoanOfferInactive(bytes32 offerId) internal virtual {
	```

- Found in src/core/lending/RefinanceManager.sol [Line: 99](src/core/lending/RefinanceManager.sol#L99)

	```solidity
	    function _getCurrencyManager() internal view virtual returns (ICurrencyManager) {
	```

- Found in src/core/lending/RequestManager.sol [Line: 110](src/core/lending/RequestManager.sol#L110)

	```solidity
	    function _setLoanRequestInactive(bytes32 requestId) internal virtual {
	```

</details>



## L-10: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>1 Found Instances</summary>


- Found in src/core/manager/CollectionManager.sol [Line: 61](src/core/manager/CollectionManager.sol#L61)

	```solidity
	        for (uint256 i = 0; i < collectionList.length; i++) {
	```

</details>



## L-11: Unused Import

Redundant import statement. Consider removing it.

<details><summary>2 Found Instances</summary>


- Found in src/core/LendingProtocol.sol [Line: 5](src/core/LendingProtocol.sol#L5)

	```solidity
	import {IERC721Receiver} from "@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol";
	```

- Found in src/core/manager/RoyaltyManager.sol [Line: 8](src/core/manager/RoyaltyManager.sol#L8)

	```solidity
	import {ILicenseTemplate} from "@storyprotocol/contracts/interfaces/modules/licensing/ILicenseTemplate.sol";
	```

</details>



## L-12: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>4 Found Instances</summary>


- Found in src/core/lending/RefinanceManager.sol [Line: 164](src/core/lending/RefinanceManager.sol#L164)

	```solidity
	    function proposeRenegotiation(
	```

- Found in src/core/lending/RequestManager.sol [Line: 36](src/core/lending/RequestManager.sol#L36)

	```solidity
	    function makeLoanRequest(ILendingProtocol.LoanRequestParams calldata params)
	```

- Found in src/core/lending/RequestManager.sol [Line: 85](src/core/lending/RequestManager.sol#L85)

	```solidity
	    function cancelLoanRequest(bytes32 requestId) public virtual nonReentrant {
	```

- Found in src/core/manager/RoyaltyManager.sol [Line: 80](src/core/manager/RoyaltyManager.sol#L80)

	```solidity
	    function withdrawRoyalty(address ipId, address currencyToken, address recipient, uint256 amount)
	```

</details>



## L-13: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>2 Found Instances</summary>


- Found in src/core/lending/LoanManager.sol [Line: 322](src/core/lending/LoanManager.sol#L322)

	```solidity
	        purchaseBundler.listCollateralForSale(
	```

- Found in src/core/manager/RoyaltyManager.sol [Line: 95](src/core/manager/RoyaltyManager.sol#L95)

	```solidity
	        IERC20(currencyToken).transfer(recipient, amount);
	```

</details>



