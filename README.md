# NFT Loan and Borrow Platform for Story IP

This project implements a decentralized platform for lending and borrowing against Non-Fungible Tokens (NFTs) that represent ownership of story-based Intellectual Property (IP).

---

## Project Overview

The platform aims to unlock liquidity for creators and owners of story IPs by allowing them to use their NFTs as collateral for loans. Lenders can earn interest by providing liquidity to the platform.

---

## Key Features

- **NFT as Collateral:** Users can lock their story IP NFTs in smart contracts to borrow stablecoins or other cryptocurrencies.
- **Loan Origination:** Lenders can offer loans with specific terms (interest rate, duration, loan-to-value ratio)
- **Interest Accrual:** Interest is accrued over the loan period, payable by the borrower.
- **Liquidation:** If a borrower defaults on their loan (e.g., fails to repay within the agreed timeframe, or the collateral value drops significantly), the platform allows for the liquidation of the NFT to cover the outstanding debt.
- **Story IP Focus:** The platform is specifically designed for NFTs representing rights to stories, scripts, characters, and other narrative-based intellectual property
- **Story Protocol Integration for Royalty-Backed Repayments:** The platform is deeply integrated with Story Protocol, allowing borrowers to use future royalties generated by their IP as a means to repay their loans. This unlocks a powerful new financial tool for creators, enabling them to leverage not just the static value of their NFT, but also its future earning potential.

---

## How it Works (Conceptual Flow)

### 1. NFT Minting (External)
Creators mint NFTs representing their story IP. These NFTs should ideally contain metadata linking to the actual IP content or legal agreements. For Story Protocol integration, the NFT must be registered with the IPAssetRegistry.

### 2. User Registration (Optional)
Users might need to register on the platform.

### 3. Loan Request (Borrower)
- A borrower lists their story IP NFT as collateral.
- They specify the desired loan amount and may indicate preferred terms.

### 4. Loan Offer (Lender)
- **Peer-to-Peer:** Lenders can browse listed NFTs and make direct loan offers with specific interest rates and durations.

### 5. Loan Agreement
- If a borrower accepts a lender's offer, a smart contract locks the NFT and disburses the loan amount to the borrower.
- The `LendingProtocol` contract checks if the collateral is a registered Story Protocol IP and stores its `storyIpId`.
- The terms of the loan (principal, interest, maturity date, collateral ID) are recorded on the blockchain.

### 6. Standard Repayment
- The borrower repays the loan principal plus accrued interest before or on the maturity date.
- Upon successful repayment, the NFT is unlocked and returned to the borrower.

### 7. Repayment via Royalties (Story Protocol Integration)
- Borrowers who have collateralized a Story Protocol-registered IP can utilize the `claimAndRepay` function.
- This function interacts with the platform's `RoyaltyManager` contract.
- The `RoyaltyManager` calls Story Protocol's RoyaltyModule to claim any accrued royalties for the specific `storyIpId`.
- These claimed funds are then automatically applied to the outstanding loan balance. If the royalties cover the entire debt, the loan is settled and the collateral is returned. If they cover a partial amount, the borrower is responsible for the remainder.

### 8. Default and Liquidation
- If the borrower fails to repay the loan by the maturity date, or if the loan-to-value (LTV) ratio exceeds a critical threshold, the loan enters a default state.
- The locked NFT can then be liquidated. This might involve:
  - Transferring the NFT to the lender.
  - Auctioning the NFT to the highest bidder, with proceeds used to cover the debt and any remaining amount (if any) returned to the borrower.

---

## Technical Stack (Anticipated)

- **Smart Contracts:** Solidity for Ethereum Virtual Machine (EVM) compatible blockchains.
- **Development Framework:** Foundry
- **Core Dependencies:**
  - `@openzeppelin/contracts` for security and standard implementations (ERC721, Ownable).
  - `@storyprotocol/contracts` for interfaces to the IIPAssetRegistry and RoyaltyModule.
- **Frontend:** (To be determined - e.g., React, Vue, Angular)
- **Backend:** (To be determined - e.g., Node.js, Python)
- **NFT Standards:** ERC-721 or ERC-1155 for representing story IP.

---

## Project Goals

- Provide a secure and transparent platform for NFT-backed loans.
- Enable creators to leverage their story IP for funding without selling their rights outright.
- Offer attractive returns for lenders willing to provide liquidity.
- Foster a new market for valuing and financing creative intellectual property by integrating with Story Protocol's royalty infrastructure.

---

## Disclaimer

This project is in the development phase. The information provided here is subject to change. Investing in NFTs and cryptocurrencies involves significant risk.

---

## Smart Contracts Detailed Report

This report provides a detailed overview of the smart contracts within the `src/core` and `src/core/lending` directories, outlining their purpose, key functionalities, and interactions.

### Table of Contents

1.  [Overview](#overview)
2.  [Core Protocol Contract](#core-protocol-contract)
    *   [LendingProtocol.sol](#lendingprotocolsol)
3.  [Manager Contracts (src/core/lending)](#manager-contracts-srccorelending)
    *   [AdminManager.sol](#adminmanagersol)
    *   [LoanManager.sol](#loanmanagersol)
    *   [OfferManager.sol](#offermanagersol)
    *   [RefinanceManager.sol](#refinancemanagersol)
    *   [RequestManager.sol](#requestmanagersol)
4.  [Supporting Service Contracts (src/core)](#supporting-service-contracts-srccore)
    *   [CollectionManager.sol](#collectionmanagersol)
    *   [CurrencyManager.sol](#currencymanagersol)
    *   [Liquidation.sol](#liquidationsol)
    *   [PurchaseBundler.sol](#purchasebundlersol)
    *   [RangeValidator.sol](#rangevalidatorsol)
    *   [RoyaltyManager.sol](#royaltymanagersol)
    *   [Stash.sol](#stashsol)
5.  [Contract Interactions Summary](#contract-interactions-summary)

---

### 1. Overview

The protocol implements a decentralized NFT lending and borrowing system. The `LendingProtocol` contract acts as the central hub, integrating functionalities from various specialized manager contracts (for offers, loans, refinancing, administration, and loan requests) and supporting service contracts (for managing collections, currencies, liquidations, etc.). This modular design enhances clarity and maintainability.

---

### 2. Core Protocol Contract

#### LendingProtocol.sol

*   **Purpose**: This is the main contract that orchestrates the entire lending and borrowing process. It integrates functionalities from several manager contracts by inheriting from them. It also holds references to other core service contracts.
*   **Key Functionalities**:
    *   Manages the overall state of the lending platform.
    *   Provides external functions for users to interact with the protocol (e.g., make offers, accept offers, repay loans).
    *   Delegates specific tasks to the respective manager contracts.
    *   Handles interactions between different modules (e.g., using `CurrencyManager` to check supported currencies, `CollectionManager` for whitelisted NFTs).
    *   Implements the `ILendingProtocol` interface, providing a unified entry point for all lending operations.
    *   Acts as a bridge for manager contracts to access shared state or cross-manager functionality through overridden internal "getter" functions (e.g., `_getCurrencyManager()`).
*   **Inherits**: `OfferManager`, `LoanManager`, `RefinanceManager`, `AdminManager`, `RequestManager`.
*   **Interacts With**: `ICurrencyManager`, `ICollectionManager`, `ILiquidation`, `IPurchaseBundler`, `IRoyaltyManager`, `IIPAssetRegistry`.

---

### 3. Manager Contracts (src/core/lending)

These contracts are designed to be inherited by `LendingProtocol.sol` and manage specific aspects of the lending lifecycle.

#### AdminManager.sol

*   **Purpose**: Manages administrative functions of the `LendingProtocol`.
*   **Key Functionalities**:
    *   Ownable: Restricts sensitive functions to the owner.
    *   Allows the owner to set and update addresses of critical dependent contracts like `CurrencyManager`, `CollectionManager`, `Liquidation`, `PurchaseBundler`, `RoyaltyManager`, and `IIPAssetRegistry`.
    *   Provides emergency withdrawal functions for ERC20, ERC721 tokens, and native ETH, callable only by the owner, to safeguard funds in unforeseen circumstances.
*   **Inherits**: `Ownable`.
*   **Interactions**:
    *   Defines virtual functions (e.g., `_setCurrencyManager`) that are implemented by `LendingProtocol` to modify its state.

#### LoanManager.sol

*   **Purpose**: Manages the lifecycle of active loans, from acceptance to repayment or default.
*   **Key Functionalities**:
    *   Handles the acceptance of loan offers (`acceptLoanOffer`) and loan requests (`acceptLoanRequest`). This includes transferring the NFT collateral to the protocol and the principal to the borrower.
    *   Calculates interest due on loans (`calculateInterest`).
    *   Processes loan repayments (`repayLoan`, `claimAndRepay`).
    *   Manages collateral claims by lenders in case of default (`claimCollateral`).
    *   Facilitates listing collateral for sale by borrowers (`listCollateralForSale`) and processes the purchase and repayment (`buyCollateralAndRepay`).
    *   Records loan repayments that occur via the `PurchaseBundler` (`recordLoanRepaymentViaSale`).
    *   Implements `IERC721Receiver` to receive NFTs.
    *   Provides views for loan status (`getLoan`, `isLoanRepayable`, `isLoanInDefault`).
*   **Inherits**: `ReentrancyGuard`, `IERC721Receiver`.
*   **Interactions**:
    *   Uses `_getCurrencyManager`, `_getCollectionManager`, `_getIpAssetRegistry`, `_getRoyaltyManager`, `_getPurchaseBundler` (provided by `LendingProtocol`) to interact with respective services.
    *   Calls `_getLoanOffer` and `_setLoanOfferInactive` (from `OfferManager` via `LendingProtocol`) when an offer is accepted.
    *   Calls `_getLoanRequest` and `_setLoanRequestInactive` (from `RequestManager` via `LendingProtocol`) when a request is accepted.
    *   Defines internal virtual functions (`_setLoanStatus`, `_incrementLoanCounter`, `_addLoan`, `_updateLoanAfterRenegotiation`) for use by other managers (like `RefinanceManager`) through `LendingProtocol`.

#### OfferManager.sol

*   **Purpose**: Manages the creation and cancellation of loan offers made by lenders.
*   **Key Functionalities**:
    *   Allows lenders to create new loan offers (`makeLoanOffer`) for specific NFTs or collections.
    *   Allows lenders to cancel their active loan offers (`cancelLoanOffer`).
    *   Provides a view to get details of a loan offer (`getLoanOffer`).
    *   Tracks loan offers in the `loanOffers` mapping.
*   **Inherits**: `ReentrancyGuard`.
*   **Interactions**:
    *   Uses `_getCurrencyManager` and `_getCollectionManager` (provided by `LendingProtocol`) to validate offer parameters.
    *   Defines an internal virtual function `_setLoanOfferInactive` to be called by `LoanManager` (via `LendingProtocol`) when an offer is accepted.

#### RefinanceManager.sol

*   **Purpose**: Manages the refinancing and renegotiation of existing loans.
*   **Key Functionalities**:
    *   Allows a new lender to refinance an existing loan (`refinanceLoan`), potentially with better terms for the borrower. This involves repaying the old lender and creating a new loan.
    *   Allows the current lender of a loan to propose new terms (`proposeRenegotiation`).
    *   Allows the borrower to accept a renegotiation proposal (`acceptRenegotiation`), thereby updating the loan terms.
    *   Tracks renegotiation proposals.
*   **Inherits**: `ReentrancyGuard`.
*   **Interactions**:
    *   Uses `_getLoan`, `_setLoanStatus`, `_incrementLoanCounter`, `_addLoan`, `_calculateInterest`, `_updateLoanAfterRenegotiation` (from `LoanManager` via `LendingProtocol`) to manage and modify loan states during refinancing and renegotiation.
    *   Uses `_getCurrencyManager` (provided by `LendingProtocol`) for currency validation if needed.

#### RequestManager.sol

*   **Purpose**: Manages loan requests made by borrowers.
*   **Key Functionalities**:
    *   Allows borrowers to create loan requests (`makeLoanRequest`).
    *   Allows borrowers to cancel their active loan requests (`cancelLoanRequest`).
    *   Provides a view to get details of a loan request (`getLoanRequest`).
*   **Inherits**: `ReentrancyGuard`.
*   **Interactions**:
    *   Uses `_getCurrencyManager` and `_getCollectionManager` (provided by `LendingProtocol`) to validate request parameters.
    *   Defines `_setLoanRequestInactive` for `LoanManager` (via `LendingProtocol`) usage.

---

### 4. Supporting Service Contracts (src/core)

#### CollectionManager.sol

*   **Purpose**: Manages whitelisted NFT collections eligible for collateral.
*   **Key Functionalities**: Add/remove collections, check whitelist status.
*   **Inherits**: `ICollectionManager`, `Ownable`, `ReentrancyGuard`.
*   **Interactions**: Used by `LendingProtocol` and its managers.

#### CurrencyManager.sol

*   **Purpose**: Manages supported ERC20 currencies for loans.
*   **Key Functionalities**: Add/remove currencies, check support status.
*   **Inherits**: `ICurrencyManager`, `Ownable`.
*   **Interactions**: Used by `LendingProtocol` and its managers.

#### Liquidation.sol

*   **Purpose**: Manages liquidation of defaulted loan collateral (auctions, buyouts).
*   **Key Functionalities**: Initiate/execute buyouts, start/manage auctions, distribute proceeds.
*   **Inherits**: `ILiquidation`, `Ownable`, `ReentrancyGuard`.
*   **Interactions**: Called by `LendingProtocol` for defaulted loans.

#### PurchaseBundler.sol

*   **Purpose**: Facilitates selling collateralized NFTs to repay loans.
*   **Key Functionalities**: List collateral, buy listed collateral (repays loan, transfers NFT & surplus).
*   **Inherits**: `IPurchaseBundler`, `Ownable`, `ReentrancyGuard`.
*   **Interactions**: `LendingProtocol` lists collateral; `PurchaseBundler` calls `LendingProtocol` to record repayment.

#### RangeValidator.sol

*   **Purpose**: Validates token IDs for collection offers (e.g., Art Blocks ranges).
*   **Key Functionalities**: Set range rules, set specific validators, check token ID validity.
*   **Inherits**: `IRangeValidator`, `Ownable`.
*   **Interactions**: Used by `OfferManager` (via `LendingProtocol`).

#### RoyaltyManager.sol

*   **Purpose**: Manages and claims royalties for IP assets using Story Protocol.
*   **Key Functionalities**: Claim royalties, track balances, withdraw royalties.
*   **Inherits**: `IRoyaltyManager`, `Ownable`.
*   **Interactions**: Used by `LoanManager` for `claimAndRepay`; interacts with Story Protocol.

#### Stash.sol

*   **Purpose**: Wraps ERC721 tokens for compatibility, creating derivative "stash tokens".
*   **Key Functionalities**: Stash original NFT (held by contract) to mint stash token, unstash to burn token and retrieve original.
*   **Inherits**: `IStash`, `ERC721`, `Ownable`, `IERC721Receiver`.
*   **Interactions**: Checks with `IIPAssetRegistry` (Story Protocol); stashed tokens could be used as collateral.

---

### 5. Contract Interactions Summary

`LendingProtocol` is central, inheriting from manager contracts and composing with service contracts. Example flow (Accepting Loan Offer): Borrower calls `LendingProtocol.acceptLoanOffer` -> `LoanManager` logic (inherited) retrieves offer via `OfferManager` bridge, validates with `CurrencyManager`/`CollectionManager` bridges, transfers NFT to `LendingProtocol`, creates loan record, deactivates offer via `OfferManager` bridge, transfers principal.
